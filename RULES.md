# Правила работы с данными

## Достоверность
- Источник истины — файлы в `sources/` и их метаданные `meta.yaml`.
- Любая новая строка в CSV должна иметь ссылку на источник (колонка `source`).
- Запрещены вымышленные значения и расчёты без подтверждения в исходниках.

## Формат данных
- Разделитель: запятая. Кодировки: UTF-8, завершающие переводы строк обязательны.
- Числа: десятичная точка, без пробелов и разделителей тысяч.
- Пустые значения: пустая строка (`""`), не использовать `-`, `NULL`, `N/A`.
- Стабильная сортировка: по ключам из `schemas/*.yaml`; менять порядок руками запрещено.
- Уникальные ключи: `(gost, iso)` для аналогов, `(code, manufacturer)` для суффиксов, `(designation, d, D, B)` для размеров, `brand` для брендов.

### Примеры правильного формата

#### ✅ Правильно
```csv
designation,d,D,B,type,source
6205,25,52,15,ball,GOST 3478-2012
6206,30,62,16,ball,GOST 3478-2012
```

#### ❌ Неправильно
```csv
designation,d,D,B,type,source
6206,30,62,16,ball,GOST 3478-2012
6205,25,52,15,ball,GOST 3478-2012  # Неправильный порядок сортировки
```

#### ✅ Правильно (числа)
```csv
d,D,B,Cr
25,52,15,14.8
```

#### ❌ Неправильно (числа)
```csv
d,D,B,Cr
25,52,15,14,8    # Запятая вместо точки
25,52,15,14 800  # Пробел в числе
```

#### ✅ Правильно (пустые значения)
```csv
designation,note
6205,""
6206,Special coating
```

#### ❌ Неправильно (пустые значения)
```csv
designation,note
6205,NULL
6206,N/A
```

## Процесс обновления
1. Поместите новый PDF/DOCX в `sources/<category>/` и добавьте запись в `meta.yaml`.
2. Обновите сырые таблицы в `scripts/extract/raw_datasets.py` с указанием источника.
3. Запустите:
   ```bash
   python scripts/update_repo.py         # нормализация CSV
   python scripts/validate/run_validations.py
   python -m pytest -q
   ```
4. Добавьте отчёт в `data/reports/YYYY-MM-DD_source.json` с входными/выходными файлами и статистикой строк.

## Контроль качества
- Валидации: `scripts/validate/csv_validator.py` проверяет схему, сортировку, типы и дубликаты.
- CI: `.github/workflows/ci.yml` запускает нормализацию, валидации и тесты на каждом push/PR.
- Любое нарушение правил формата считается блокирующим и должно быть исправлено до коммита.

### Описание валидаторов

#### CSV валидатор (`scripts/validate/csv_validator.py`)
Проверяет следующие аспекты:
- **Схема**: соответствие столбцов определениям в `schemas/*.yaml`
- **Типы данных**: корректность типов (string, integer, float, boolean)
- **Уникальность**: отсутствие дубликатов по уникальным ключам
- **Сортировка**: корректный порядок строк согласно схеме
- **Обязательные поля**: наличие значений в required полях
- **Формат**: UTF-8 кодировка, правильные разделители

Пример использования:
```bash
python scripts/validate/csv_validator.py data/gost/bearings.csv schemas/gost.yaml
```

#### Запуск всех валидаций
```bash
python scripts/validate/run_validations.py
```

Эта команда проверит все CSV файлы в директориях `data/gost/`, `data/iso/`, `data/analogs/`, `data/brands/` на соответствие схемам.

#### Интеграция в процесс разработки
1. Перед коммитом запустите валидацию локально
2. CI автоматически проверит ваши изменения
3. При обнаружении ошибок PR не будет одобрен до их исправления
